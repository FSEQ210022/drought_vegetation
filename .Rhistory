200-2023
2000-2023
eddi(runif(24)) ->a
quantile(a$EDDI)
hist(a$EDDI)
dir <- '/mnt/md0/SoilMoisture_1km_Chile/regresion/'
dir_ls(dir,recurse = TRUE)
dir_ls(dir,recurse = TRUE)
dir_ls('/mnt/md0/SoilMoisture_1km_Chile/regresion/swc_chl_layer3_monthly')
paste0('swc_chl_layer',1:3,'_monthly')
paste0(dir,lyrs[1])
lyrs <- paste0('swc_chl_layer',1:3,'_monthly')
dir_ls(paste0(dir,lyrs[1]))
swlyr1 <- dir_ls(paste0(dir,lyrs[1]))
swlyr2 <- dir_ls(paste0(dir,lyrs[2]))
swlyr3 <- dir_ls(paste0(dir,lyrs[3]))
seq_along(swlyr1)
swlyr1
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i])
}
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]))
sm
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]),seq_alon = 'layer')
sm
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]),seq_along = 'layer')
sm
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]),along = 'layer')
sm
sm <- st_set_dimensions(sm,'layer',values = c('layer1','layer2','layer3'))
sm
sm_mean <- st_apply(sm,1:2,mean)
sm_mean
sm_mean |> plot()
library(tictoc)
i <-1
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]),along = 'layer')
sm <- st_set_dimensions(sm,'layer',values = c('layer1','layer2','layer3'))
cl <- makeCluster(80,"SOCK")
stopCluster(cl)
tic()
cl <- makeCluster(80,"SOCK")
sm_mean <- st_apply(sm,1:2,mean,CLUSTER = cl)
toc()
stopCluster(cl)
tic()
#cl <- makeCluster(80,"SOCK")
sm_mean <- st_apply(sm,1:2,mean)
toc()
(seq_along(swlyr1)
seq_along(swlyr1)
453*30
13590/60
226/60
swlyr1
dir_out <- '/mnt/md0/SoilMoisture_1km_Chile/regresion/swc_chl_0-100cm_monthly/'
swlyr1
str_split_i(swlyr1,6)
str_split_i(swlyr1,'/',6)
str_split_i(swlyr1,'/',7)
new_names <- str_split_i(swlyr1,'/',7)
new_names
new_names <- paste0(dir_out,str_split_i(swlyr1,'/',7))
new_names
lapply(seq_along(swlyr1),\(i){
lapply(seq_along(swlyr1),\(i){
lapply(seq_along(swlyr1),\(i){
sm <- read_stars(c(swlyr1[i],swlyr2[i],swlyr3[i]),along = 'layer')
sm <- st_set_dimensions(sm,'layer',values = c('layer1','layer2','layer3'))
tic()
sm_mean <- st_apply(sm,1:2,mean)
write_stars(sm_mean,dsn = new_names[i])
toc()
})
library(fs)
library(stars)
library(stringr)
library(lubridate)
dir_in <- '/mnt/md0/SoilMoisture_1km_Chile/regresion/swc_chl_0-100cm_monthly/'
files <- dir_ls(dir_in)
files
dates <- as.Date(str_extract(files,'[0-9]{7}'),'%Y%j')
dates
yj <- format(dates,'%Y%j')
files <- dir_ls(dir_in)
files
dates <- as.Date(str_extract(files,'[0-9]{7}'),'%Y%m%d')
dates
str_extract(files,'[0-9]{7}')
dates <- as.Date(str_extract(files,'[0-9]{8}'),'%Y%m%d')
dates
yj <- format(dates,'%Y%j')
yj <- format(dates,'%Y%j')
dir_out <- '/mnt/md0/SoilMoisture_1km_Chile/SMDI_chl_0-100cm_monthly//'
new_names <- paste0(dir_out,'chl_',yj,'_1_km_monthly_SMDI.tif')
indxs <- lapply(1:12,\(i) which(month(dates) == i))
indxs
for (i in seq_along(indxs)){
library(snow)
sm <- read_stars(files[indxs[[i]]], along ='dates')
sm <- st_set_dimensions(sm,'dates', values= dates[indxs[[i]]])
cl <- makeCluster(80,"SOCK")
clusterExport(cl, list = c('eddi','pe'))
smdi <- st_apply(X = sm,MARGIN = 1:2,FUN = \(x) eddi(x)$EDDI,PROGRESS = TRUE, CLUSTER = cl, .fname = 'dates')
stopCluster(cl)
smdi <- aperm(smdi,c(2,3,1))
lapply(1:dim(smdi)[3],\(j){
write_stars(smdi[,,,j],dsn = new_names[indxs[[i]]][j])
})
}
pe <- function(x){
if (!all(is.na(x))){
r <- rank(x)
out <- (r-0.33)/(length(x)+0.33)
} else out <- rep(NA,length(x))
out
}
eddi <- function(x){
if (!all(is.na(x))){
C0 = 2.515517
C1 = 0.802853
C2 = 0.010328
d1 = 1.432788
d2 = 0.189269
d3 = 0.001308
pe <- pe(x)
data <- data.frame(x=x,pe=pe)
out <- data |>
dplyr::mutate(W = dplyr::case_when(
pe <= .5 ~ sqrt(-2*log(1-pe)),
pe > .5 ~ sqrt(-2*log(pe))
),
EDDI = W - (C0+C1*W+C2*W^2)/(1+d1*W+d2*W^2+d3*W^3),
EDDI = dplyr::case_when(
pe <= .5 ~ EDDI,
pe > .5 ~ -EDDI)
)
} else out <- data.frame(EDDI = rep(NA,length(x)))
return(out)
}
dir_in <- '/mnt/md0/SoilMoisture_1km_Chile/regresion/swc_chl_0-100cm_monthly/'
files <- dir_ls(dir_in)
dates <- as.Date(str_extract(files,'[0-9]{8}'),'%Y%m%d')
yj <- format(dates,'%Y%j')
dir_out <- '/mnt/md0/SoilMoisture_1km_Chile/SMA_chl_0-100cm_monthly//'
new_names <- paste0(dir_out,'chl_',yj,'_1_km_monthly_SMDI.tif')
indxs <- lapply(1:12,\(i) which(month(dates) == i))
for (i in seq_along(indxs)){
library(snow)
sma <- read_stars(files[indxs[[i]]], along ='dates')
sma <- st_set_dimensions(sma,'dates', values= dates[indxs[[i]]])
cl <- makeCluster(80,"SOCK")
clusterExport(cl, list = c('eddi','pe'))
sma <- st_apply(X = sma,MARGIN = 1:2,FUN = \(x) eddi(x)$EDDI,PROGRESS = TRUE, CLUSTER = cl, .fname = 'dates')
stopCluster(cl)
sma <- aperm(sma,c(2,3,1))
lapply(1:dim(sma)[3],\(j){
write_stars(sma[,,,j],dsn = new_names[indxs[[i]]][j])
})
}
stopCluster(cl)
for (i in seq_along(indxs)){
library(snow)
sma <- read_stars(files[indxs[[i]]], along ='dates')
sma <- st_set_dimensions(sma,'dates', values= dates[indxs[[i]]])
cl <- makeCluster(80,"SOCK")
clusterExport(cl, list = c('eddi','pe'))
sma <- st_apply(X = sma,MARGIN = 1:2,FUN = \(x) eddi(x)$EDDI,PROGRESS = TRUE, CLUSTER = cl, .fname = 'dates')
stopCluster(cl)
sma <- aperm(sma,c(2,3,1))
lapply(1:dim(sma)[3],\(j){
write_stars(sma[,,,j],dsn = new_names[indxs[[i]]][j])
})
}
x <- 1:10
x
10:(10-3)
10:(10-scale(-1))
10:(10-(scale-1))
sacle <- 3
10:(10-(scale-1))
scale-1
scale <- 3
10:(10-(scale-1))
10:(10-scale-1)
x
10:scale
lapply(10:scale,\(n) n:(n-(scale-1)),scale=3)
lapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=3)
sapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=3)
x
sapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=6)
10:scale
scale <- 6
sapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=6)
rast(10,10)
library(terra)
pre <- rast(10,10)
pre <- rast(matrix(1:100,10,10))
pre
values(pre) <- runif(1:100)
plot(pre)
im <- lapply(1:10, function(){
)
im <- lapply(1:10, function(){
values(pre) <- runif(1:100)
})
rep(pre,10)
pre <- rep(pre,100)
indxs <- sapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs
indxs <- lapply(10:scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs
nlyr(pre)
indxs <- lapply(nlyr(pre):scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs
pre_sum <- lapply(indxs,function(ix){
app(pre[[ix]],sum)
})
pre_sum
rast(pre_sum)
indxs
rev(pre)
names(pre_sum) <-paste(lyr,1:100)
names(pre_sum) <-paste('lyr',1:100)
names(pre_sum) <-paste('lyr',1:95)
names(pre_sum)
names(rev(pre_sum))
names(pre_sum) <-paste('lyr',5:100)
names(pre_sum) <-paste('lyr',6:100)
names(rev(pre_sum))
dir_out <- '/mnt/md0/CHELSA_v2.1/monthly/'
rasio <-  list(nYOff = 1, nYSize = 1000)
et <- read_stars(dir_ls(glue('{dir_out}/pet')), along = 'time',proxy = TRUE,
RasterIO = rasio)
library(glue)
rasio <-  list(nYOff = 1, nYSize = 1000)
et <- read_stars(dir_ls(glue('{dir_out}/pet')), along = 'time',proxy = TRUE,
RasterIO = rasio)
pre <- read_stars(dir_ls(glue('{dir_out}/pre'))[2:484], along = 'time',proxy = TRUE,
RasterIO = rasio)
dir_ls(glue('{dir_out}/pet'))
et <- read_stars(dir_ls(glue('{dir_out}/pet')), along = 'time',proxy = TRUE,
RasterIO = rasio)
et <- read_stars(dir_ls(glue('{dir_out}/pet'),regexp = 'tif$'), along = 'time',proxy = TRUE,
RasterIO = rasio)
pre <- read_stars(dir_ls(glue('{dir_out}/pre'),regexp = 'tif$')[2:484], along = 'time',proxy = TRUE,
RasterIO = rasio)
plot(et)
plot(et[,,,100])
plot(pre[,,,100])
5*30
plot(pre[,,,100])
plot(pre[,,,100]*0.01)
D <- pre-et
plot(D[,,,100])
D
st_as_stars(D[,,,100]))
st_as_stars(D[,,,100])
273/30
27/30
lf_et <- dir_ls(glue('{dir_out}/pet'),regexp = 'tif$')
lf_et
lf_pr <- dir_ls(glue('{dir_out}/pr'),regexp = 'tif$')
lf_pr <- dir_ls(glue('{dir_out}/pre'),regexp = 'tif$')
lf_pr
lf_pre[1:10]
lf_pr[1:10]
lf_pet[1:10]
lf_pet <- dir_ls(glue('{dir_out}/pet'),regexp = 'tif$')
lf_pet <- dir_ls(glue('{dir_out}/pet'),regexp = 'tif$')
lf_pet[1:10]
lf_pet |> tail()
lf_pr |> tail()
lf_pr <- dir_ls(glue('{dir_out}/pre'),regexp = 'tif$')[2:484]
head(lf_pet)
head(lf_pr)
tail(lf_pet)
tail(lf_pr)
pet <- read_stars(lf_pet, along = 'dates')
pet
indxs <- lapply(nlyr(pre):scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs <- lapply(dim(pre)[3]:scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs
scale
scale <- 12
indxs <- lapply(dim(pre)[3]:scale,\(n,scale) n:(n-(scale-1)),scale=6)
indxs
scale <- 12
indxs <- lapply(dim(pre)[3]:scale,\(n,scale) n:(n-(scale-1)),scale=12)
indxs
indxs[[1]]
plot(pet[,,,1])
pet
pet <- read_stars(lf_pet, along = 'dates',RasterIO = rasio)
plot(pet[,,,1])
pre <- read_stars(lf_pr, along = 'dates',RasterIO = rasio)
scale <- 12
indxs <- lapply(dim(pre)[3]:scale,\(n,scale) n:(n-(scale-1)),scale=12)
D <- 0.01*pre - pet
pre
pet
st_dimension(pet)
st_dimensions(pet)
pet[,,,1]-pre[,,,1]
st_get_dimension_values(pet,'x')
st_get_dimension_values(pre,'x')
a1 <- st_get_dimension_values(pre,'x')
a2 <- st_get_dimension_values(pre,'x')
all.equal(a1,a2)
a2 <- st_get_dimension_values(pre,'y')
a1 <- st_get_dimension_values(pre,'x')
a2 <- st_get_dimension_values(pet,'x')
all.equal(a1,a2)
pre$CHELSA_pr_v2.1_19790201.tif
pre$CHELSA_pr_v2.1_19790201.tif - pet$CHELSA_pet_v2.1_19790201.tif
0.01*pre
D <- pre
D$CHELSA_pr_v2.1_19790201.tif <- NA
D
D$CHELSA_pr_v2.1_19790201.tif <- 0.01*pre$CHELSA_pr_v2.1_19790201.tif - pet$CHELSA_pet_v2.1_19790201.tif
D
plot(D[,,1])
plot(D[,,,1])
names(D) <- 'diff'
D
x <- 1:100
scale <- 3
indxs <- lapply(length(x)[3]:scale,\(n,scale) n:(n-(scale-1)),scale=scale)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
indxs
lapply(indxs,\(ix) sum(x[ix]))
vapply(indxs,\(ix) sum(x[ix]))
sapply(indxs,\(ix) sum(x[ix]))
rev(sapply(indxs,\(ix) sum(x[ix])))
pe <- function(x){
if (!all(is.na(x))){
r <- rank(x)
out <- (r-0.33)/(length(x)+0.33)
} else out <- rep(NA,length(x))
out
}
eddi <- function(x){
if (!all(is.na(x))){
C0 = 2.515517
C1 = 0.802853
C2 = 0.010328
d1 = 1.432788
d2 = 0.189269
d3 = 0.001308
pe <- pe(x)
data <- data.frame(x=x,pe=pe)
out <- data |>
dplyr::mutate(W = dplyr::case_when(
pe <= .5 ~ sqrt(-2*log(1-pe)),
pe > .5 ~ sqrt(-2*log(pe))
),
EDDI = W - (C0+C1*W+C2*W^2)/(1+d1*W+d2*W^2+d3*W^3),
EDDI = dplyr::case_when(
pe <= .5 ~ EDDI,
pe > .5 ~ -EDDI)
)
} else out <- data.frame(EDDI = rep(NA,length(x)))
return(out)
}
x
calc_spei <- function(x,scale){
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
eddi(vals)
}
calc_spei(x)
calc_spei(x,3)
calc_spei(x,12)
length(x)
x[sample(1:100,10)]
x[sample(1:100,10)] <- NA
x
calc_spei(x)
calc_spei(x,13)
calc_spei <- function(x,scale){
x <- na.omit(x)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
eddi(vals)
}
calc_spei(x,13)
dim(calc_spei(x,13))
x <- rep(NA,100)
calc_spei(x,13)
x <- na.omit(x)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
sapply(indxs,\(ix) sum(x[ix]))
indxs
length(x)
calc_spei <- function(x,scale){
x <- na.omit(x)
#if(length)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
eddi(vals)$EDDI
}
x
x <- 1:100
x[sample(1:100,50)] <- NA
x
calc_spei(x)
calc_spei(x,3)
x[sample(1:100,70)] <- NA
calc_spei(x,3)
x[sample(1:100,80)] <- NA
calc_spei(x,3)
x
x <- na.omit(x)
length(x)
!is.na(x)
x
x <- 1:100
x[sample(1:100,10)]
x[sample(1:100,10)] <- NA
no_na <- !is.na(x)
no_na
calc_spei <- function(x,scale){
out <- rep(NA,length(x))
no_na <- !is.na(x)
x <- na.omit(x)
if (length(x) >= scale){
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
out[no_na] <- eddi(vals)$EDDI
}
out
}
x
calc_spei(x,12)
x
out <- rep(NA,length(x))
out
no_na <- !is.na(x)
no_na
x <- na.omit(x)
length(x)
scale
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
indxs
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
vals
out[no_na]
eddi(vals)$EDDI
out[no_na] |> length()
x
x <- 1:100
out <- rep(NA,length(x))
no_na <- !is.na(x)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
vals
x[sample(1:100,20)] <- NA
out <- rep(NA,length(x))
no_na <- !is.na(x)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix])))
vals
vals <- rev(sapply(indxs,\(ix) sum(x[ix],na.rm = TRUE)))
vals
x
out <- rep(NA,length(x))
nas <- is.na(x)
nas <- is.na(x)
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix],na.rm = TRUE)))
vals <- na.omit(vals)
out <- eddi(vals)$EDDI
out
out[nas] <- NA
out
x
calc_spei(x,3)
calc_spei <- function(x,scale){
nas <- is.na(x)
if (length(x) >= scale){
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix],na.rm = TRUE)))
vals <- na.omit(vals)
out <- eddi(vals)$EDDI
out[nas] <- NA
}
out
}
calc_spei(x,3)
calc_spei(x,12)
calc_spei(x,24)
calc_spei <- function(x,scale){
nas <- is.na(x)
if (length(x) >= scale){
indxs <- lapply(length(x):scale,\(n,scale) n:(n-(scale-1)),scale=scale)
vals <- rev(sapply(indxs,\(ix) sum(x[ix],na.rm = TRUE)))
vals <- na.omit(vals)
out <- eddi(vals)$EDDI
out[nas] <- NA
}
out
}
cl <- makeCluster(80,"SOCK")
clusterExport(cl, list = c('eddi','pe','calc_spei'))
D_sum <- st_apply(D,1:2,calc_spei,scale = 12,CLUSTER = cl,PROGRESS = TRUE)
D_sum
plot(D_sum[,1,,,])
plot(D_sum[,1,,])
rm(list=ls())
gc()
gc()
