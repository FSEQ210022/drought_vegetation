{
    "type": [
        2,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        3,
        3,
        3,
        0,
        1,
        3,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        2,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        0,
        1,
        3,
        2,
        2,
        3,
        3,
        2,
        0,
        2
    ],
    "data": [
        "\nR version 4.1.0 (2021-05-18) -- \"Camp Pontanezen\"\nCopyright (C) 2021 The R Foundation for Statistical Computing\nPlatform: x86_64-pc-linux-gnu (64-bit)\n\nR es un software libre y viene sin GARANTIA ALGUNA.\nUsted puede redistribuirlo bajo ciertas circunstancias.\nEscriba 'license()' o 'licence()' para detalles de distribucion.\n\nR es un proyecto colaborativo con muchos contribuyentes.\nEscriba 'contributors()' para obtener más información y\n'citation()' para saber cómo citar R o paquetes de R en publicaciones.\n\n",
        "Escriba 'demo()' para demostraciones, 'help()' para el sistema on-line de ayuda,\no 'help.start()' para abrir el sistema de ayuda HTML con su navegador.\nEscriba 'q()' para salir de R.\n\n",
        "> ",
        "product <- 'NDVI.MOD13Q1.006/'",
        "> ",
        "",
        "> ",
        "dir <- paste0('/mnt/HDD4TB_2/data/rasters/Procesados/MODIS/',product)",
        "> ",
        "dir.ph <- '/mnt/HDD4TB_2/data/rasters/Procesados/MODIS/Phenology/'",
        "> ",
        "",
        "> ",
        "library(stars)",
        "Loading required package: abind\n",
        "Loading required package: sf\n",
        "Linking to GEOS 3.9.0, GDAL 3.2.2, PROJ 7.2.1; sf_use_s2() is TRUE\n",
        "> ",
        "library(terra)",
        "terra 1.5.21\n",
        "> ",
        "library(sf)",
        "> ",
        "library(snow)",
        "> ",
        "",
        "> ",
        "pol <- st_read('data/spatial/chile_continental.gpkg')",
        "Reading layer `chile_continental' from data source \n  `/mnt/0FA1FA650427517A/OneDrive/R-projects/drought-vegetation/data/spatial/chile_continental.gpkg' \n  using driver `GPKG'\nSimple feature collection with 1 feature and 2 fields\nGeometry type: MULTIPOLYGON\nDimension:     XY\nBounding box:  xmin: -75.68856 ymin: -55.97945 xmax: -66.41828 ymax: -17.49849\nGeodetic CRS:  WGS 84\n",
        "> ",
        "pol <- st_transform(pol,32719)",
        "> ",
        "lf <- list.files(dir,pattern='*.tif$', full.names=TRUE)",
        "> ",
        "#",
        "> ",
        "ysize = 100",
        "> ",
        "sliceY <- seq(3580,22015,ysize)",
        "> ",
        "",
        "> ",
        "source('R/functions/cumRast.R')",
        "> ",
        "source('R/functions/getPerPixel.R')",
        "> ",
        "source('R/functions/smoothNDVI.R')",
        "> ",
        "",
        "> ",
        "sos <- disagg(rast(file.path(dir.ph,'SOS.Chile.S1.500m.tif')),2)",
        "> ",
        "eos <- disagg(rast(file.path(dir.ph,'EOS.Chile.S1.500m.tif')),2)",
        "> ",
        "sos_eos <- c(sos,eos)",
        "> ",
        "",
        "> ",
        "",
        "> ",
        "lapply(1:length(sliceY),function(i){",
        "+ ",
        "  rasterio <- list(nXOff = 6088, nYOff = sliceY[i]+1, nXSize = 3081, nYSize = ysize)",
        "+ ",
        "  ",
        "+ ",
        "  ndvi <- read_stars(lf, along ='dates',RasterIO = rasterio)",
        "+ ",
        "  ndvi <- st_as_stars(ndvi)",
        "+ ",
        "  sos_eosC <- st_as_stars(st_crop(st_as_stars(sos_eos),ndvi)) %>% st_set_dimensions(3,name = 'dates')",
        "+ ",
        "  ",
        "+ ",
        "  dates <- as.Date(substr(lf,67,74),\"%Y%j\")",
        "+ ",
        "  ",
        "+ ",
        "  message('Suavizado NDVI...')",
        "+ ",
        "  ",
        "+ ",
        "  cl <- makeCluster(11,\"SOCK\")",
        "+ ",
        "  NDVI_smooth <- st_apply(ndvi,1:2,smoothNDVI,n=5,CLUSTER = cl,PROGRESS = TRUE,.fname = 'dates')",
        "+ ",
        "",
        "+ ",
        "  NDVI_smooth <- st_as_stars(NDVI_smooth) ",
        "+ ",
        "  NDVI_smooth <- merge(split(NDVI_smooth,'dates'),name='dates')",
        "+ ",
        "  ",
        "+ ",
        "  ",
        "+ ",
        "  esNDVI <- c(sos_eosC,NDVI_smooth, along = 'dates')",
        "+ ",
        "  ",
        "+ ",
        "  rm(NDVI_smooth)",
        "+ ",
        "  gc()",
        "+ ",
        "  ",
        "+ ",
        "  message('Acmulado NDVI..')",
        "+ ",
        "  eoscNDVI <- st_apply(esNDVI,1:2,cumRast,dates = dates, step = 16, get = c('eos',21),CLUSTER = cl,PROGRESS = TRUE,.fname = 'dates')",
        "+ ",
        "  stopCluster(cl)",
        "+ ",
        "  ",
        "+ ",
        "  eoscNDVI <- merge(split(eoscNDVI,'dates'),name='dates')",
        "+ ",
        "  ",
        "+ ",
        "  rm(esNDVI)",
        "+ ",
        "  gc()",
        "+ ",
        "  ",
        "+ ",
        "  # message('Obteniendo cNDVI en SOS..')",
        "+ ",
        "  # secNDVI <- c(c(sosC,eosC,along ='dates'),cNDVI,along='dates')",
        "+ ",
        "  # soscNDVI <- st_apply(secNDVI,1:2,getPerPixel,dates = dates, at='eos',lead=0,step = 16,CLUSTER = cl,PROGRESS = TRUE,.fname = 'dates')",
        "+ ",
        "  # soscNDVI <- merge(split(soscNDVI,'dates'),name='dates')",
        "+ ",
        "  # ",
        "+ ",
        "  # rm(secNDVI)",
        "+ ",
        "  # gc()",
        "+ ",
        "  ",
        "+ ",
        "  message('Scale cNDVI en SOS..')",
        "+ ",
        "  #cl <- makeCluster(11,\"SOCK\")",
        "+ ",
        "  zcNDVI <- st_apply(eoscNDVI,1:2,function(x){scale(x)[,1]},PROGRESS = TRUE,.fname = 'zcNDVI')",
        "+ ",
        "  #stopCluster(cl)",
        "+ ",
        "  zcNDVI <- merge(split(zcNDVI,'zcNDVI'),name='zcNDVI')",
        "+ ",
        "",
        "+ ",
        "  ",
        "+ ",
        "  saveRDS(zcNDVI,paste0('~/.starstemp/zcNDVI_',i,'.rds'))",
        "+ ",
        "  rm(zcNDVI)",
        "+ ",
        "  gc()",
        "+ ",
        "})",
        "Suavizado NDVI...\n",
        "\r  |                                                  | 0 % ~calculating  \r  |+                                                 | 1 % ~21s          \r  |+                                                 | 2 % ~19s          \r  |++                                                | 3 % ~18s          \r  |++                                                | 4 % ~18s          \r  |+++                                               | 5 % ~17s          \r  |+++                                               | 6 % ~17s          ",
        "\r  |++++                                              | 7 % ~17s          ",
        "There were 50 or more warnings (use warnings() to see the first 50)",
        "\n",
        "\n",
        "> ",
        "\nRestarting R session...\n\n"
    ]
}